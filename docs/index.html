<!doctype html>
<html>

    <head>
        <title>ECN</title>
        <meta charset="UTF-8">
        <script src="dist/d3.js"></script>
    </head>

    <body>
        <div id="myplot"></div>
        <script>
            // set the dimensions and margins of the graph
            var margin = {top: 10, right: 30, bottom: 30, left: 60},
                width = 1060 - margin.left - margin.right,
                height = 400 - margin.top - margin.bottom;

            // append the svg object to the body of the page
            var svg = d3.select("#myplot")
                .append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform",
                      "translate(" + margin.left + "," + margin.top + ")");   

            // Read data
            const all = d3.dsv(";", "http://alexdarcy.github.io/ecn/2020-2016.csv");

            all.then(function(data) {
                // Convert to integer
                data.forEach(function(x) {
                    x.annee = +x.annee;
                    x.rang = +x.rang;
                })

                // Rank max by specialty and town
                rankMax = d3.rollup(data, v => d3.max(v, d => d.rang), d => d.specialite,
                                    d => d.annee, d => d.ville);
                // console.log(rankMax);
                //
                // For now, fix the year
                spe = rankMax.get("génétique médicale").get(2020);
                console.log(spe);

                // Get the list of town for y-axis
                towns = Array.from(spe.keys());
                console.log(towns);
                console.log(towns.length);

                console.log(spe.get("Grenoble"));
                // console.log(d3.min(neuro, d => d.rang));

                // Add X axis --> it is a date format
                 var x = d3.scaleLinear()
                     .domain(d3.extent(spe, function(d) { return d[1]; }))
                     .range([ 0, width ]);
                 svg.append("g")
                     .attr("transform", "translate(0," + height + ")")
                     .call(d3.axisBottom(x));

                 // Add Y axis
                 var y = d3.scaleBand()
                     .domain(towns)
                     .range([ height, 0 ]);
                 svg.append("g")
                     .call(d3.axisLeft(y));

                 // Add dots !! The map becomes an array there !!
                 // 0 is the town, 1 is the rank max
                 svg.append('g')
                     .selectAll("dot")
                     .data(spe)
                     .enter()
                     .append("circle")
                    .attr("cx", function (d) {return x(d[1]); } )
                     .attr("cy", function (d) { return y(d[0]); } )
                     .attr("r", 3)
                     .style("fill", "#69b3a2")
            });
        </script>
    </body>
</html>
